name: Claude Code Planner-Executor (Write Access)

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  claude-planner-executor:
    # Only trigger on @claude-planner-executor command from authorized users
    if: |
      (
        github.event_name == 'issue_comment' ||
        github.event_name == 'pull_request_review_comment'
      ) &&
      contains(github.event.comment.body, '@claude-planner-executor') &&
      contains(fromJSON('["varunisrani"]'), github.event.comment.user.login)

    runs-on: ubuntu-latest

    permissions:
      contents: write # Allow creating branches and editing files
      pull-requests: write # Allow creating and updating pull requests
      issues: write # Allow commenting on and updating issues
      id-token: write # Required for OIDC authentication
      actions: read # Read CI results

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better context

      - name: Extract plan file path and load instructions
        id: load-instructions
        run: |
          # Get the issue or PR number from the event
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          else
            ISSUE_NUMBER="${{ github.event.pull_request.number }}"
          fi

          # Extract the plan file path from the comment
          # Expected format: @claude-planner-executor path/to/plan.md
          COMMENT_BODY="${{ github.event.comment.body }}"

          # Extract file path after @claude-planner-executor
          PLAN_FILE=$(echo "$COMMENT_BODY" | grep -oP '@claude-planner-executor\s+\K[^\s]+\.md' || echo "")

          if [ -z "$PLAN_FILE" ]; then
            echo "ERROR: No plan file specified. Usage: @claude-planner-executor path/to/plan.md"
            echo "PLAN_FILE_ERROR=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if the plan file exists
          if [ ! -f "$PLAN_FILE" ]; then
            echo "ERROR: Plan file not found: $PLAN_FILE"
            echo "PLAN_FILE_ERROR=true" >> $GITHUB_OUTPUT
            echo "PLAN_FILE_PATH=$PLAN_FILE" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "PLAN_FILE_ERROR=false" >> $GITHUB_OUTPUT
          echo "PLAN_FILE_PATH=$PLAN_FILE" >> $GITHUB_OUTPUT

          # Read the plan file content
          PLAN_CONTENT=$(cat "$PLAN_FILE")

          # Read the template and replace the AI_ASSISTANT placeholder
          INSTRUCTIONS=$(cat .github/planner_executor_prompt.md | sed 's/{AI_ASSISTANT}/claude/g')

          # Use heredoc to preserve multiline content with context prepended
          echo "CUSTOM_INSTRUCTIONS<<EOF" >> $GITHUB_OUTPUT
          echo "# GitHub Context" >> $GITHUB_OUTPUT
          echo "- Repository: ${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "- Issue/PR Number: ${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
          echo "- Triggered by: ${{ github.event.comment.user.login }}" >> $GITHUB_OUTPUT
          echo "- Plan File: ${PLAN_FILE}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "$INSTRUCTIONS" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "---" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "# PLAN TO EXECUTE" >> $GITHUB_OUTPUT
          echo "**File: ${PLAN_FILE}**" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "$PLAN_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post error message if plan file not found
        if: steps.load-instructions.outputs.PLAN_FILE_ERROR == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const planFile = '${{ steps.load-instructions.outputs.PLAN_FILE_PATH }}';
            let errorMessage = '';

            if (!planFile) {
              errorMessage = `No plan file specified.\n\n**Usage:** \`@claude-planner-executor path/to/plan.md\`\n\nExample: \`@claude-planner-executor docs/implementation-plan.md\``;
            } else {
              errorMessage = `Plan file not found: \`${planFile}\`\n\nPlease ensure the file exists in the repository and the path is correct.`;
            }

            const comment = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${errorMessage}`
            };

            if (context.eventName === 'issue_comment') {
              await github.rest.issues.createComment({
                ...comment,
                issue_number: context.issue.number
              });
            } else if (context.eventName === 'pull_request_review_comment') {
              await github.rest.pulls.createReplyForReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                comment_id: context.payload.comment.id,
                body: comment.body
              });
            }

      - name: Run Claude Code Planner-Executor
        if: steps.load-instructions.outputs.PLAN_FILE_ERROR == 'false'
        id: claude
        uses: anthropics/claude-code-action@beta
        timeout-minutes: 60
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Custom trigger phrase for planner-executor workflow
          trigger_phrase: "@claude-planner-executor"

          # Planner-executor instructions loaded from template with plan content
          custom_instructions: ${{ steps.load-instructions.outputs.CUSTOM_INSTRUCTIONS }}

          # Commented out - using default tools
          # allowed_tools: "Edit(*),MultiEdit(*),Write(*),Read(*),Grep(*),LS(*),Glob(*),TodoWrite(*),NotebookEdit(*),Bash(git *),Bash(npm *),Bash(uv *),Bash(python *),Bash(pip *),Bash(cd *),Bash(pwd),Bash(ls *),Bash(cat *),Bash(head *),Bash(tail *),Bash(wc *),Bash(find *),Bash(grep *),Bash(rg *),Bash(sed *),Bash(awk *),Bash(curl *),Bash(wget *),Bash(echo *),Bash(mkdir *),Bash(rm -rf node_modules),Bash(rm -rf __pycache__),Bash(rm -rf .pytest_cache),WebSearch(*),WebFetch(*)"

  unauthorized-message:
    # Post message for unauthorized users
    if: |
      (
        github.event_name == 'issue_comment' ||
        github.event_name == 'pull_request_review_comment'
      ) &&
      contains(github.event.comment.body, '@claude-planner-executor') &&
      !contains(fromJSON('["varunisrani"]'), github.event.comment.user.login)

    runs-on: ubuntu-latest

    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: Post unauthorized message
        uses: actions/github-script@v7
        with:
          script: |
            const comment = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `@${context.actor} - You are not authorized to trigger Claude planner-executor.\n\nOnly maintainers can trigger Claude: Please ask a maintainer to run the planner-executor command.`
            };

            if (context.eventName === 'issue_comment') {
              await github.rest.issues.createComment({
                ...comment,
                issue_number: context.issue.number
              });
            } else if (context.eventName === 'pull_request_review_comment') {
              await github.rest.pulls.createReplyForReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                comment_id: context.payload.comment.id,
                body: comment.body
              });
            }